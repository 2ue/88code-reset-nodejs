# E2E ç«¯åˆ°ç«¯æµ‹è¯•

## ğŸ“‹ æ¦‚è¿°

E2E (End-to-End) æµ‹è¯•æ¨¡æ‹Ÿ `pnpm start` çš„å®Œæ•´è¿è¡Œæµç¨‹ï¼ŒéªŒè¯ç³»ç»Ÿä»å¯åŠ¨åˆ°æ‰§è¡Œé‡ç½®çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚

**ä¸å•å…ƒæµ‹è¯•çš„åŒºåˆ«**:
- âœ… **å•å…ƒæµ‹è¯•**: æµ‹è¯•å•ä¸ªå‡½æ•°/æ¨¡å—çš„è¡Œä¸ºï¼ˆé›¶ç¢æµ‹è¯•ï¼‰
- âœ… **E2E æµ‹è¯•**: æµ‹è¯•å®Œæ•´ç³»ç»Ÿè¿è¡Œæµç¨‹ï¼ˆæ•´ä½“æµ‹è¯•ï¼‰

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è¿è¡Œæ‰€æœ‰ E2E æµ‹è¯•ï¼ˆé»˜è®¤å®Œæ•´æµç¨‹ï¼‰
```bash
pnpm run test:e2e
```

### è¿è¡Œç‰¹å®šåœºæ™¯
```bash
# å®Œæ•´æµç¨‹æµ‹è¯• (FIRST + SECOND checkpoint)
pnpm run test:e2e:full

# ä»… FIRST checkpoint (18:55)
pnpm run test:e2e:first

# ä»… SECOND checkpoint (23:58ï¼ŒåŒ…å«å»¶è¿Ÿé‡ç½®)
pnpm run test:e2e:second

# å»¶è¿Ÿé‡ç½®ä¸“é¡¹æµ‹è¯•
pnpm run test:e2e:delayed
```

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
tests/e2e/
â”œâ”€â”€ full-flow.test.js          # E2E æµ‹è¯•ä»£ç 
â”œâ”€â”€ run-e2e.js                 # æµ‹è¯•è¿è¡Œå™¨
â”œâ”€â”€ .env.e2e.full              # å®Œæ•´æµç¨‹é…ç½®
â”œâ”€â”€ .env.e2e.first-only        # ä»… FIRST checkpoint é…ç½®
â”œâ”€â”€ .env.e2e.second-only       # ä»… SECOND checkpoint é…ç½®
â”œâ”€â”€ .env.e2e.delayed           # å»¶è¿Ÿé‡ç½®é…ç½®
â””â”€â”€ README.md                  # æœ¬æ–‡æ¡£
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯è¯´æ˜

### 1. å®Œæ•´æµç¨‹æµ‹è¯• (`full`)

**æ¨¡æ‹Ÿåœºæ™¯**: æ­£å¸¸è¿è¡Œä¸€å¤©ï¼Œæ‰§è¡Œä¸¤æ¬¡æ£€æŸ¥ç‚¹

**æµ‹è¯•å†…å®¹**:
- âœ… å¯åŠ¨ Scheduler æœåŠ¡
- âœ… 18:55 è§¦å‘ FIRST checkpoint
- âœ… 23:58 è§¦å‘ SECOND checkpoint
- âœ… éªŒè¯é‡ç½®é€»è¾‘
- âœ… éªŒè¯é€šçŸ¥å‘é€
- âœ… éªŒè¯æ•°æ®æŒä¹…åŒ–

**è¿è¡Œæ–¹å¼**:
```bash
pnpm run test:e2e:full
```

**é¢„æœŸç»“æœ**:
```
ğŸš€ [E2E] å¯åŠ¨ Scheduler...
â° [E2E] è§¦å‘ FIRST checkpoint (18:55)...
âœ… [E2E] FIRST checkpoint å®Œæˆ: 2 æˆåŠŸ, 0 è°ƒåº¦
â° [E2E] è§¦å‘ SECOND checkpoint (23:58)...
âœ… [E2E] SECOND checkpoint å®Œæˆ: 1 æˆåŠŸ, 1 è°ƒåº¦
ğŸ“§ [E2E] é€šçŸ¥å‘é€: 2 æ¬¡
ğŸ’¾ [E2E] æ•°æ®æŒä¹…åŒ–: 2 æ¡è®°å½•
```

---

### 2. FIRST Checkpoint ä¸“é¡¹æµ‹è¯• (`first-only`)

**æ¨¡æ‹Ÿåœºæ™¯**: åªåœ¨ 18:55 æ‰§è¡Œé‡ç½®

**æµ‹è¯•å†…å®¹**:
- âœ… åªå¤„ç† `resetTimes >= 2` çš„è®¢é˜…
- âœ… è·³è¿‡ cooldown æœªè¿‡çš„è®¢é˜…
- âœ… ä¸è°ƒåº¦å»¶è¿Ÿé‡ç½®

**è¿è¡Œæ–¹å¼**:
```bash
pnpm run test:e2e:first
```

**é…ç½®å·®å¼‚**:
```bash
# .env.e2e.first-only
FIRST_RESET_TIME=18:55
SECOND_RESET_TIME=          # ç¦ç”¨ SECOND
```

---

### 3. SECOND Checkpoint ä¸“é¡¹æµ‹è¯• (`second-only`)

**æ¨¡æ‹Ÿåœºæ™¯**: åªåœ¨ 23:58 æ‰§è¡Œé‡ç½®ï¼ˆåŒ…å«å»¶è¿Ÿé‡ç½®ï¼‰

**æµ‹è¯•å†…å®¹**:
- âœ… å¤„ç† `resetTimes >= 1` çš„è®¢é˜…
- âœ… Cooldown å·²è¿‡çš„ç«‹å³é‡ç½®
- âœ… Cooldown æœªè¿‡çš„è°ƒåº¦å»¶è¿Ÿé‡ç½®

**è¿è¡Œæ–¹å¼**:
```bash
pnpm run test:e2e:second
```

**é…ç½®å·®å¼‚**:
```bash
# .env.e2e.second-only
FIRST_RESET_TIME=           # ç¦ç”¨ FIRST
SECOND_RESET_TIME=23:58
```

---

### 4. å»¶è¿Ÿé‡ç½®ä¸“é¡¹æµ‹è¯• (`delayed`)

**æ¨¡æ‹Ÿåœºæ™¯**: éªŒè¯å»¶è¿Ÿé‡ç½®æœºåˆ¶

**æµ‹è¯•å†…å®¹**:
- âœ… Cooldown æœªè¿‡æ—¶æ­£ç¡®è°ƒåº¦
- âœ… å®šæ—¶å™¨æ­£ç¡®è®¾ç½®
- âœ… å»¶è¿Ÿé‡ç½®æ­£ç¡®æ‰§è¡Œï¼ˆåŠ é€ŸéªŒè¯ï¼‰

**è¿è¡Œæ–¹å¼**:
```bash
pnpm run test:e2e:delayed
```

**å…³é”®éªŒè¯ç‚¹**:
```javascript
// è°ƒåº¦å»¶è¿Ÿé‡ç½®
assert.strictEqual(result.scheduled, 2);
assert.strictEqual(timerCount, 2);

// ç­‰å¾…æ‰§è¡Œï¼ˆæ—¶é—´åŠ é€Ÿï¼‰
await new Promise(resolve => setTimeout(resolve, 3000));

// éªŒè¯æ‰§è¡Œ
assert.ok(apiClient.resetCallCount > 0);
```

---

## ğŸ”§ é…ç½®æ–‡ä»¶è¯´æ˜

### é€šç”¨é…ç½®é¡¹

æ‰€æœ‰ E2E ç¯å¢ƒé…ç½®éƒ½åŒ…å«ï¼š

```bash
# API Mockï¼ˆä¸è°ƒç”¨çœŸå®æ¥å£ï¼‰
API_KEYS=test-api-key-xxx

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=info              # full/first/second ä½¿ç”¨
LOG_LEVEL=debug             # delayed ä½¿ç”¨ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰

# é€Ÿç‡é™åˆ¶ï¼ˆç¦ç”¨ä»¥åŠ å¿«æµ‹è¯•ï¼‰
ENABLE_RATE_LIMIT=false
REQUEST_INTERVAL_MS=50

# é€šçŸ¥ï¼ˆä½¿ç”¨ Mockï¼‰
ENABLE_TELEGRAM=false
ENABLE_WECOM=false

# æ ‡è¯†æµ‹è¯•ç¯å¢ƒ
NODE_ENV=e2e-test-xxx
```

### åœºæ™¯ç‰¹å®šé…ç½®

| é…ç½®é¡¹ | full | first-only | second-only | delayed |
|--------|------|------------|-------------|---------|
| `FIRST_RESET_TIME` | 18:55 | 18:55 | *(ç©º)* | 18:55 |
| `SECOND_RESET_TIME` | 23:58 | *(ç©º)* | 23:58 | 23:58 |
| `LOG_LEVEL` | info | info | info | **debug** |
| `COOLDOWN_HOURS` | 5 | 5 | 5 | 5 |

---

## ğŸ¯ æµ‹è¯•éªŒè¯ç‚¹

### æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- âœ… **PAYGO ä¿æŠ¤**: æ°¸ä¸é‡ç½® PAYGO è®¢é˜…
- âœ… **resetTimes ç­–ç•¥**:
  - FIRST: `resetTimes >= 2`
  - SECOND: `resetTimes >= 1`
- âœ… **Cooldown é€»è¾‘**:
  - FIRST: cooldown æœªè¿‡ç›´æ¥è·³è¿‡
  - SECOND: cooldown æœªè¿‡è°ƒåº¦å»¶è¿Ÿé‡ç½®
- âœ… **å®šæ—¶ä»»åŠ¡**: æ­£ç¡®è°ƒåº¦å’Œæ‰§è¡Œ

### æ•°æ®æµè½¬
- âœ… **API è°ƒç”¨**: Mock API æ­£ç¡®å“åº”
- âœ… **çŠ¶æ€æ›´æ–°**: resetTimes æ­£ç¡®é€’å‡
- âœ… **é€šçŸ¥å‘é€**: æ¯æ¬¡æ£€æŸ¥ç‚¹å‘é€é€šçŸ¥
- âœ… **æ•°æ®æŒä¹…åŒ–**: é‡ç½®å†å²æ­£ç¡®ä¿å­˜

### é”™è¯¯å¤„ç†
- âœ… **API å¤±è´¥**: ä¸å½±å“å…¶ä»–è®¢é˜…
- âœ… **é€šçŸ¥å¤±è´¥**: ä¸é˜»å¡ä¸»æµç¨‹
- âœ… **å®šæ—¶å™¨æ¸…ç†**: æ— èµ„æºæ³„æ¼

---

## ğŸ“Š æµ‹è¯•è¾“å‡ºç¤ºä¾‹

### æˆåŠŸè¾“å‡º

```
ğŸ§ª E2E æµ‹è¯•è¿è¡Œå™¨
ğŸ“‹ åœºæ™¯: full
ğŸ“„ é…ç½®æ–‡ä»¶: .env.e2e.full

============================================================

âœ… å·²åŠ è½½ç¯å¢ƒé…ç½®: full

ğŸš€ [E2E] å¯åŠ¨ Scheduler...
ğŸ“… [E2E] å½“å‰æ—¶é—´: 2025-11-07 23:45:00

â° [E2E] è§¦å‘ FIRST checkpoint (18:55)...
âœ… [E2E] FIRST checkpoint å®Œæˆ: 2 æˆåŠŸ, 0 è°ƒåº¦

â³ [E2E] ç­‰å¾…æ—¶é—´æµé€...

â° [E2E] è§¦å‘ SECOND checkpoint (23:58)...
âœ… [E2E] SECOND checkpoint å®Œæˆ: 1 æˆåŠŸ, 1 è°ƒåº¦

ğŸ“§ [E2E] é€šçŸ¥å‘é€: 2 æ¬¡
ğŸ’¾ [E2E] æ•°æ®æŒä¹…åŒ–: 2 æ¡è®°å½•
â²ï¸  [E2E] å»¶è¿Ÿé‡ç½®å®šæ—¶å™¨: 1 ä¸ª

ğŸ§¹ [E2E] æ¸…ç†å®Œæˆ

âœ” åº”è¯¥æ¨¡æ‹Ÿå®Œæ•´çš„ pnpm start æµç¨‹ (1234ms)

============================================================

âœ… E2E æµ‹è¯•é€šè¿‡ (åœºæ™¯: full)
```

### å¤±è´¥è¾“å‡º

```
âœ– åº”è¯¥æ¨¡æ‹Ÿå®Œæ•´çš„ pnpm start æµç¨‹
  AssertionError: FIRST checkpoint should reset some subscriptions
    expected: > 0
    actual: 0

âŒ E2E æµ‹è¯•å¤±è´¥ (åœºæ™¯: full)
```

---

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

ä¿®æ”¹ç¯å¢ƒé…ç½®ï¼š
```bash
# .env.e2e.xxx
LOG_LEVEL=debug     # æ”¹ä¸º debug
```

### 2. å•ç‹¬è¿è¡Œæµ‹è¯•

```bash
# ç›´æ¥è¿è¡Œæµ‹è¯•æ–‡ä»¶ï¼ˆä½¿ç”¨å½“å‰ .envï¼‰
node --test tests/e2e/full-flow.test.js
```

### 3. æ£€æŸ¥ç¯å¢ƒé…ç½®

```bash
# æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„é…ç½®
cat .env
```

### 4. æ·»åŠ æ–­ç‚¹

åœ¨æµ‹è¯•ä»£ç ä¸­æ·»åŠ ï¼š
```javascript
console.log('[DEBUG] Current state:', {
  eligible: result.eligible,
  success: result.success,
  scheduled: result.scheduled,
});
```

---

## ğŸ’¡ ä¸ `pnpm start` çš„å¯¹æ¯”

| ç‰¹æ€§ | `pnpm start` | E2E æµ‹è¯• |
|------|--------------|----------|
| **å¯åŠ¨æ–¹å¼** | çœŸå®è¿›ç¨‹ | ç›´æ¥å¯¼å…¥æ¨¡å— |
| **æ—¶é—´è°ƒåº¦** | çœŸå® cron | æ‰‹åŠ¨è§¦å‘ |
| **API è°ƒç”¨** | çœŸå®æ¥å£ | Mock API |
| **æ‰§è¡Œæ—¶é—´** | 24å°æ—¶ | ~5ç§’ |
| **é€šçŸ¥å‘é€** | çœŸå®é€šçŸ¥ | Mock é€šçŸ¥ |
| **æ•°æ®æŒä¹…åŒ–** | çœŸå®æ–‡ä»¶ | Mock å­˜å‚¨ |

**ä¼˜åŠ¿**:
- âœ… å¿«é€Ÿåé¦ˆï¼ˆç§’çº§è€Œéå°æ—¶çº§ï¼‰
- âœ… æ— å‰¯ä½œç”¨ï¼ˆä¸è°ƒç”¨çœŸå® APIï¼‰
- âœ… å¯é‡å¤æ‰§è¡Œ
- âœ… æ˜“äºè°ƒè¯•

**å±€é™**:
- âš ï¸ ä¸æµ‹è¯•çœŸå®ç½‘ç»œ
- âš ï¸ ä¸æµ‹è¯•çœŸå®æ–‡ä»¶ I/O
- âš ï¸ ä¸æµ‹è¯•çœŸå® cron è°ƒåº¦

---

## ğŸ”„ æŒç»­é›†æˆ

å¯ä»¥å°† E2E æµ‹è¯•åŠ å…¥ CI/CD æµç¨‹ï¼š

```yaml
# .github/workflows/test.yml
- name: Run E2E Tests
  run: |
    pnpm run test:e2e:full
    pnpm run test:e2e:first
    pnpm run test:e2e:second
    pnpm run test:e2e:delayed
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆ E2E æµ‹è¯•è¿™ä¹ˆå¿«ï¼Ÿ
A: ä½¿ç”¨äº†æ—¶é—´åŠ é€Ÿï¼ˆ3600xï¼‰å’Œ Mock ä¾èµ–ï¼Œ5å°æ—¶ cooldown å‹ç¼©ä¸º5ç§’ã€‚

### Q: E2E æµ‹è¯•ä¼šè°ƒç”¨çœŸå® API å—ï¼Ÿ
A: ä¸ä¼šï¼Œæ‰€æœ‰å¤–éƒ¨ä¾èµ–éƒ½ä½¿ç”¨ Mockã€‚

### Q: å¦‚ä½•æ·»åŠ æ–°çš„æµ‹è¯•åœºæ™¯ï¼Ÿ
A: å¤åˆ¶ç°æœ‰ `.env.e2e.xxx` æ–‡ä»¶ï¼Œä¿®æ”¹é…ç½®ï¼Œæ·»åŠ åˆ° `package.json` scriptsã€‚

### Q: E2E æµ‹è¯•å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
A:
1. æ£€æŸ¥ç¯å¢ƒé…ç½®æ˜¯å¦æ­£ç¡®
2. å¯ç”¨ `LOG_LEVEL=debug` æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
3. å¯¹æ¯”å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•æ˜¯å¦é€šè¿‡
4. æ£€æŸ¥ Mock æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

è¿è¡Œ E2E æµ‹è¯•å‰ç¡®è®¤ï¼š

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ (`pnpm test:unit`)
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡ (`pnpm test:integration`)
- [ ] ç¯å¢ƒé…ç½®æ–‡ä»¶å­˜åœ¨
- [ ] Mock æ¨¡å—å·¥ä½œæ­£å¸¸
- [ ] æ— å…¶ä»–è¿›ç¨‹å ç”¨ç«¯å£

---

**ç”Ÿæˆæ—¶é—´**: 2025-11-07
**æµ‹è¯•æ¡†æ¶**: Node.js Test Runner (å†…ç½®)
**é¡¹ç›®ç®¡ç†**: pnpm
