# 88code è‡ªåŠ¨é‡ç½®å·¥å…· - é¡¹ç›®æ¶æ„æ–‡æ¡£

## ğŸ“ æ•´ä½“æ¶æ„è®¾è®¡

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åº”ç”¨å±‚                                â”‚
â”‚                      (src/index.js)                          â”‚
â”‚  - åº”ç”¨å…¥å£                                                   â”‚
â”‚  - åˆå§‹åŒ–æœåŠ¡                                                 â”‚
â”‚  - ç”Ÿå‘½å‘¨æœŸç®¡ç†                                               â”‚
â”‚  - ä¼˜é›…å…³é—­                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       è°ƒåº¦å±‚                                  â”‚
â”‚                   (src/core/Scheduler.js)                    â”‚
â”‚  - å®šæ—¶ä»»åŠ¡ç®¡ç† (node-cron)                                  â”‚
â”‚  - ä»»åŠ¡é”æ§åˆ¶                                                â”‚
â”‚  - 18:55 é¦–æ¬¡é‡ç½®                                            â”‚
â”‚  - 23:56 äºŒæ¬¡é‡ç½®                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ä¸šåŠ¡å±‚                                  â”‚
â”‚                 (src/core/ResetService.js)                   â”‚
â”‚  - é‡ç½®é€»è¾‘ç¼–æ’                                              â”‚
â”‚  - è®¢é˜…è¿‡æ»¤ (6å±‚æ£€æŸ¥)                                        â”‚
â”‚  - å»¶è¿Ÿé‡ç½®è°ƒåº¦                                              â”‚
â”‚  - ç»“æœæ±‡æ€»                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                   â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      APIé€šä¿¡å±‚         â”‚   â”‚     å·¥å…·å±‚            â”‚
    â”‚ (src/core/APIClient)   â”‚   â”‚   (src/utils/*)      â”‚
    â”‚  - HTTPå®¢æˆ·ç«¯          â”‚   â”‚  - Logger            â”‚
    â”‚  - è¯·æ±‚/å“åº”æ‹¦æˆª       â”‚   â”‚  - TimeUtils         â”‚
    â”‚  - é€Ÿç‡é™åˆ¶            â”‚   â”‚  - RateLimiter       â”‚
    â”‚  - é‡è¯•æœºåˆ¶            â”‚   â”‚  - RetryHelper       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         88code API                    â”‚
    â”‚  POST /api/usage                      â”‚
    â”‚  POST /api/subscription               â”‚
    â”‚  POST /api/reset-credits/{id}         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ç›®å½•ç»“æ„

```
88code-reset-nodejs/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒä¸šåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ APIClient.js        # APIé€šä¿¡å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ ResetService.js     # é‡ç½®æœåŠ¡ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
â”‚   â”‚   â””â”€â”€ Scheduler.js        # è°ƒåº¦å™¨ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å±‚
â”‚   â”‚   â”œâ”€â”€ Logger.js           # æ—¥å¿—ç³»ç»Ÿ (winston)
â”‚   â”‚   â”œâ”€â”€ RateLimiter.js      # é€Ÿç‡é™åˆ¶å™¨ï¼ˆä»¤ç‰Œæ¡¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ RetryHelper.js      # é‡è¯•åŠ©æ‰‹ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
â”‚   â”‚   â””â”€â”€ TimeUtils.js        # æ—¶é—´å·¥å…·ç±»
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                # å­˜å‚¨å±‚
â”‚   â”‚   â””â”€â”€ FileStorage.js      # æ–‡ä»¶å­˜å‚¨ï¼ˆå†å²è®°å½•ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ config.js               # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ constants.js            # å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ index.js                # åº”ç”¨å…¥å£
â”‚
â”œâ”€â”€ logs/                       # æ—¥å¿—ç›®å½•ï¼ˆè¿è¡Œæ—¶åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ combined.log            # æ‰€æœ‰æ—¥å¿—
â”‚   â”œâ”€â”€ error.log               # é”™è¯¯æ—¥å¿—
â”‚   â””â”€â”€ reset-YYYY-MM-DD.log    # æŒ‰æ—¥æœŸåˆ†å‰²
â”‚
â”œâ”€â”€ data/                       # æ•°æ®ç›®å½•ï¼ˆè¿è¡Œæ—¶åˆ›å»ºï¼‰
â”‚   â””â”€â”€ reset-YYYY-MM-DD.json   # é‡ç½®å†å²è®°å½•
â”‚
â”œâ”€â”€ .env                        # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ .env.example                # é…ç½®æ¨¡æ¿
â”œâ”€â”€ package.json                # é¡¹ç›®ä¾èµ–
â”œâ”€â”€ README.md                   # ä½¿ç”¨è¯´æ˜
â”œâ”€â”€ ARCHITECTURE.md             # æ¶æ„æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”œâ”€â”€ LOGIC_FLOW.md               # é€»è¾‘æµç¨‹æ–‡æ¡£
â””â”€â”€ DELAYED_RESET.md            # å»¶è¿Ÿé‡ç½®åŠŸèƒ½è¯´æ˜
```

---

## ğŸ—ï¸ åˆ†å±‚æ¶æ„è¯¦è§£

### 1. åº”ç”¨å±‚ (Application Layer)

**æ–‡ä»¶:** `src/index.js`

**èŒè´£:**
- åº”ç”¨ç¨‹åºå…¥å£
- æœåŠ¡åˆå§‹åŒ–å’Œä¾èµ–æ³¨å…¥
- ç”Ÿå‘½å‘¨æœŸç®¡ç†
- ä¼˜é›…å…³é—­å¤„ç†
- æµ‹è¯•æ¨¡å¼æ”¯æŒ

**æ ¸å¿ƒä»£ç :**
```javascript
async function main() {
    // 1. æµ‹è¯•æ¨¡å¼
    if (process.argv.includes('--mode=test') || config.runTestOnStart) {
        await runTest();
    }

    // 2. åˆå§‹åŒ–æœåŠ¡
    const apiClients = config.apiKeys.map(apiKey => new APIClient(apiKey));
    const resetServices = apiClients.map(client => new ResetService(client));

    // 3. å¯åŠ¨è°ƒåº¦å™¨
    scheduler = new Scheduler(resetService);
    await scheduler.start();
}

// ä¼˜é›…å…³é—­
process.on('SIGTERM', async () => {
    if (scheduler) scheduler.stop();
    await Logger.end();
    process.exit(0);
});
```

---

### 2. è°ƒåº¦å±‚ (Scheduler Layer)

**æ–‡ä»¶:** `src/core/Scheduler.js`

**èŒè´£:**
- å®šæ—¶ä»»åŠ¡ç®¡ç†ï¼ˆåŸºäº node-cronï¼‰
- ä»»åŠ¡æ‰§è¡Œé”ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
- æ—¶åŒºæ”¯æŒ
- ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´æ˜¾ç¤º

**æ ¸å¿ƒæœºåˆ¶:**

```javascript
class Scheduler {
    constructor(resetService) {
        this.resetService = resetService;
        this.lock = new ExecutionLock();
        this.jobs = [];
    }

    async start() {
        // é¦–æ¬¡é‡ç½®ä»»åŠ¡ (18:55)
        const firstCron = TimeUtils.toCronExpression(config.firstResetTime);
        const firstJob = cron.schedule(firstCron, () => {
            this.executeWithLock(LOCK_NAMES.FIRST_RESET, RESET_TYPES.FIRST);
        }, { timezone: config.timezone });

        // äºŒæ¬¡é‡ç½®ä»»åŠ¡ (23:56)
        const secondCron = TimeUtils.toCronExpression(config.secondResetTime);
        const secondJob = cron.schedule(secondCron, () => {
            this.executeWithLock(LOCK_NAMES.SECOND_RESET, RESET_TYPES.SECOND);
        }, { timezone: config.timezone });
    }

    async executeWithLock(lockName, resetType) {
        if (!await this.lock.acquire(lockName)) {
            return; // å·²åœ¨æ‰§è¡Œä¸­ï¼Œè·³è¿‡
        }

        try {
            await this.resetService.executeReset(resetType);
        } finally {
            this.lock.release(lockName);
        }
    }
}
```

**ä»»åŠ¡é”æœºåˆ¶:**
- ä½¿ç”¨ Map å­˜å‚¨é”çŠ¶æ€
- é˜²æ­¢åŒä¸€ä»»åŠ¡å¹¶å‘æ‰§è¡Œ
- è‡ªåŠ¨é‡Šæ”¾é”

---

### 3. ä¸šåŠ¡å±‚ (Business Layer)

**æ–‡ä»¶:** `src/core/ResetService.js`

**èŒè´£:**
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ç¼–æ’
- è®¢é˜…è¿‡æ»¤ï¼ˆ6å±‚æ£€æŸ¥ï¼‰
- å»¶è¿Ÿé‡ç½®è°ƒåº¦
- ç»“æœæ±‡æ€»å’Œç»Ÿè®¡

**æ ¸å¿ƒæµç¨‹:**

```javascript
class ResetService {
    async executeReset(resetType) {
        // 1. è·å–è®¢é˜…åˆ—è¡¨
        const subscriptions = await this.apiClient.getSubscriptions();

        // 2. è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„è®¢é˜…
        const eligible = subscriptions.filter(sub => this.isEligible(sub, resetType));

        // 3. ä¸²è¡Œå¤„ç†è®¢é˜…
        for (const subscription of eligible) {
            if (resetType === RESET_TYPES.SECOND) {
                // ç¬¬äºŒæ¬¡é‡ç½®ï¼šæ”¯æŒå»¶è¿Ÿ
                await this.processSubscriptionWithDelay(subscription, resetType);
            } else {
                // é¦–æ¬¡é‡ç½®ï¼šæ­£å¸¸å¤„ç†
                await this.processSubscription(subscription, resetType);
            }
        }

        // 4. æ±‡æ€»ç»“æœ
        return result;
    }
}
```

**6å±‚è¿‡æ»¤æ£€æŸ¥:**

| ä¼˜å…ˆçº§ | æ£€æŸ¥é¡¹ | è¯´æ˜ |
|--------|--------|------|
| P0 | PAYGOä¿æŠ¤ | å››é‡æ£€æŸ¥ï¼Œæ’é™¤æŒ‰é‡ä»˜è´¹è®¢é˜… |
| P1 | è®¢é˜…ç±»å‹ | planType === 'MONTHLY' |
| P1 | æ¿€æ´»çŠ¶æ€ | isActive === true |
| P2 | å†·å´æ£€æŸ¥ | è·ç¦»ä¸Šæ¬¡é‡ç½® â‰¥ 5å°æ—¶ |
| P3 | æ¬¡æ•°æ£€æŸ¥ | é¦–æ¬¡: resetTimes==2<br>äºŒæ¬¡: resetTimesâ‰¥1 |

---

### 4. APIé€šä¿¡å±‚ (API Layer)

**æ–‡ä»¶:** `src/core/APIClient.js`

**èŒè´£:**
- HTTPå®¢æˆ·ç«¯å°è£…ï¼ˆåŸºäº axiosï¼‰
- è¯·æ±‚/å“åº”æ‹¦æˆªå™¨
- é€Ÿç‡é™åˆ¶é›†æˆ
- é‡è¯•æœºåˆ¶é›†æˆ

**æ‹¦æˆªå™¨æ¶æ„:**

```javascript
class APIClient {
    setupInterceptors() {
        // è¯·æ±‚æ‹¦æˆªå™¨
        this.client.interceptors.request.use(async (config) => {
            // 1. é€Ÿç‡é™åˆ¶æ£€æŸ¥
            await APIClient.rateLimiter.waitForToken();

            // 2. æ·»åŠ è®¤è¯å¤´
            config.headers.Authorization = this.apiKey;

            // 3. è®°å½•æ—¥å¿—
            Logger.debug(`APIè¯·æ±‚: ${config.method} ${config.url}`);

            return config;
        });

        // å“åº”æ‹¦æˆªå™¨
        this.client.interceptors.response.use(
            (response) => {
                Logger.debug(`APIå“åº”: ${response.status}`);
                return response;
            },
            (error) => {
                // ç‰¹æ®Šé”™è¯¯å¤„ç†
                if (error.response.status === 429) {
                    error.message = 'APIé™æµï¼Œè¯·ç¨åé‡è¯•';
                }
                return Promise.reject(error);
            }
        );
    }
}
```

**APIæ–¹æ³•:**
- `getUsage()` - è·å–ç”¨é‡ä¿¡æ¯
- `getSubscriptions()` - è·å–è®¢é˜…åˆ—è¡¨
- `resetCredits(id)` - é‡ç½®æŒ‡å®šè®¢é˜…
- `testConnection()` - æµ‹è¯•è¿æ¥

---

### 5. å·¥å…·å±‚ (Utility Layer)

#### 5.1 Logger (æ—¥å¿—ç³»ç»Ÿ)

**æ–‡ä»¶:** `src/utils/Logger.js`

**æŠ€æœ¯æ ˆ:** winston

**ç‰¹æ€§:**
- å¤šçº§åˆ«æ—¥å¿— (debug, info, warn, error, success)
- åŒè¾“å‡ºï¼ˆæ§åˆ¶å° + æ–‡ä»¶ï¼‰
- æ—¥å¿—è½®è½¬ï¼ˆæŒ‰å¤§å°å’Œæ—¥æœŸï¼‰
- API Key è„±æ•

**é…ç½®:**
```javascript
const logger = winston.createLogger({
    level: config.logLevel,
    format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.printf(info =>
            `[${info.timestamp}] [${info.level}] ${info.message}`
        )
    ),
    transports: [
        new winston.transports.Console(),
        new winston.transports.DailyRotateFile({
            filename: 'logs/reset-%DATE%.log',
            datePattern: 'YYYY-MM-DD',
            maxSize: config.logMaxSize + 'm',
            maxFiles: config.logMaxDays + 'd',
        }),
    ],
});
```

---

#### 5.2 RateLimiter (é€Ÿç‡é™åˆ¶å™¨)

**æ–‡ä»¶:** `src/utils/RateLimiter.js`

**ç®—æ³•:** ä»¤ç‰Œæ¡¶ (Token Bucket)

**å‚æ•°:**
- å®¹é‡: 10ä¸ªä»¤ç‰Œ
- è¡¥å……é€Ÿç‡: 10ä¸ª/åˆ†é’Ÿ

**å®ç°:**
```javascript
class RateLimiter {
    constructor(capacity, refillRate) {
        this.tokens = capacity;
        this.refillRate = refillRate;
        this.lastRefill = Date.now();
    }

    refill() {
        const now = Date.now();
        const elapsed = now - this.lastRefill;
        const tokensToAdd = (elapsed / 60000) * this.refillRate;

        this.tokens = Math.min(this.capacity, this.tokens + tokensToAdd);
        this.lastRefill = now;
    }

    async waitForToken(maxWaitMs = 60000) {
        const startTime = Date.now();

        while (Date.now() - startTime < maxWaitMs) {
            this.refill();
            if (this.tokens >= 1) {
                this.tokens -= 1;
                return true;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        return false;
    }
}
```

---

#### 5.3 RetryHelper (é‡è¯•åŠ©æ‰‹)

**æ–‡ä»¶:** `src/utils/RetryHelper.js`

**ç­–ç•¥:** æŒ‡æ•°é€€é¿ (Exponential Backoff)

**å‚æ•°:**
- æœ€å¤§é‡è¯•æ¬¡æ•°: 3æ¬¡
- å»¶è¿ŸåŸºæ•°: 1ç§’
- å»¶è¿Ÿå…¬å¼: `baseDelay * 2^attempt`

**é‡è¯•æ¡ä»¶:**
```javascript
static defaultShouldRetry(error) {
    // é‡è¯•ï¼šç½‘ç»œé”™è¯¯ã€è¶…æ—¶ã€5xxã€429
    if (!error.response) return true;
    if (error.code === 'ECONNABORTED') return true;

    const status = error.response.status;
    if (status >= 500) return true;
    if (status === 429) return true;

    // ä¸é‡è¯•ï¼š401ã€403ã€400
    return false;
}
```

---

#### 5.4 TimeUtils (æ—¶é—´å·¥å…·)

**æ–‡ä»¶:** `src/utils/TimeUtils.js`

**æ ¸å¿ƒæ–¹æ³•:**

| æ–¹æ³• | åŠŸèƒ½ |
|------|------|
| `checkCooldown()` | æ£€æŸ¥5å°æ—¶å†·å´æœŸ |
| `formatDuration()` | æ ¼å¼åŒ–æ—¶é—´æ®µ |
| `formatDateTime()` | æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ |
| `parseCronTime()` | è§£ææ—¶é—´å­—ç¬¦ä¸² |
| `toCronExpression()` | ç”ŸæˆCronè¡¨è¾¾å¼ |
| `getTodayEnd()` | è·å–23:59:49æ—¶é—´æˆ³ |
| `getCooldownEndTime()` | è®¡ç®—å†·å´ç»“æŸæ—¶é—´ |

**å»¶è¿Ÿé‡ç½®æ”¯æŒ:**
```javascript
static getTodayEnd() {
    const todayEnd = new Date();
    todayEnd.setHours(23, 59, 59, 999);
    return todayEnd.getTime() - DELAYED_RESET_CONFIG.END_OF_DAY_BUFFER;
}

static getCooldownEndTime(lastResetTimeStr) {
    const lastResetTime = new Date(lastResetTimeStr).getTime();
    return lastResetTime + COOLDOWN_PERIOD;
}
```

---

### 6. å­˜å‚¨å±‚ (Storage Layer)

**æ–‡ä»¶:** `src/storage/FileStorage.js`

**èŒè´£:**
- æŒä¹…åŒ–é‡ç½®å†å²
- æŒ‰æ—¥æœŸåˆ†å‰²æ–‡ä»¶
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•

**å­˜å‚¨æ ¼å¼:**
```json
// data/reset-2025-11-06.json
[
  {
    "timestamp": "2025-11-06T10:55:00Z",
    "resetType": "FIRST",
    "totalSubscriptions": 2,
    "success": 2,
    "failed": 0,
    "details": [...]
  }
]
```

---

### 7. é…ç½®å±‚ (Configuration Layer)

#### 7.1 config.js

**èŒè´£:**
- åŠ è½½ç¯å¢ƒå˜é‡
- é…ç½®éªŒè¯
- é»˜è®¤å€¼è®¾ç½®

**é…ç½®é¡¹åˆ†ç±»:**
```javascript
export const config = {
    // APIé…ç½®
    apiKeys: parseAPIKeys(process.env.API_KEYS),
    apiBaseURL: process.env.API_BASE_URL || 'https://www.88code.org',
    apiTimeout: parseInt(process.env.API_TIMEOUT) || 30000,

    // é‡ç½®ç­–ç•¥
    firstResetTime: process.env.FIRST_RESET_TIME || '18:55',
    secondResetTime: process.env.SECOND_RESET_TIME || '23:56',
    timezone: process.env.TIMEZONE || 'Asia/Shanghai',

    // é‡è¯•é…ç½®
    enableRetry: process.env.ENABLE_RETRY !== 'false',
    maxRetries: parseInt(process.env.MAX_RETRIES) || 3,

    // é€Ÿç‡é™åˆ¶
    enableRateLimit: process.env.ENABLE_RATE_LIMIT !== 'false',
    rateLimitCapacity: parseInt(process.env.RATE_LIMIT_CAPACITY) || 10,

    // æ—¥å¿—é…ç½®
    logLevel: process.env.LOG_LEVEL || 'info',
    logFileEnabled: process.env.LOG_FILE_ENABLED !== 'false',
};
```

#### 7.2 constants.js

**èŒè´£:**
- å®šä¹‰ç³»ç»Ÿå¸¸é‡
- APIç«¯ç‚¹
- è®¢é˜…ç±»å‹
- é‡ç½®çŠ¶æ€

**å…³é”®å¸¸é‡:**
```javascript
export const COOLDOWN_PERIOD = 5 * 60 * 60 * 1000; // 5å°æ—¶

export const DELAYED_RESET_CONFIG = {
    END_OF_DAY_BUFFER: 10 * 1000,  // 10ç§’ç¼“å†²
    DAY_IN_MS: 24 * 60 * 60 * 1000,
};

export const RESET_TYPES = {
    FIRST: 'FIRST',    // 18:55
    SECOND: 'SECOND',  // 23:56
    MANUAL: 'MANUAL',
};
```

---

## ğŸ”„ æ•°æ®æµ

### æ­£å¸¸é‡ç½®æµç¨‹

```
1. Scheduler (18:55è§¦å‘)
   â†“
2. ResetService.executeReset(FIRST)
   â†“
3. APIClient.getSubscriptions()
   â†’ 88code API
   â† è®¢é˜…åˆ—è¡¨
   â†“
4. ResetService.isEligible() (è¿‡æ»¤)
   â†’ ç¬¦åˆæ¡ä»¶çš„è®¢é˜…
   â†“
5. ResetService.processSubscription()
   â†“
6. APIClient.resetCredits(id)
   â†’ 88code API
   â† é‡ç½®å“åº”
   â†“
7. éªŒè¯ç»“æœ + è®°å½•æ—¥å¿—
   â†“
8. FileStorage.saveResetHistory()
```

### å»¶è¿Ÿé‡ç½®æµç¨‹

```
1. Scheduler (23:56è§¦å‘)
   â†“
2. ResetService.executeReset(SECOND)
   â†“
3. ResetService.processSubscriptionWithDelay()
   â†“
4. æ£€æŸ¥å†·å´çŠ¶æ€
   â”œâ”€ å·²è¿‡å†·å´ â†’ ç›´æ¥é‡ç½®
   â””â”€ å†·å´ä¸­ â†’
      â†“
      è®¡ç®—å†·å´ç»“æŸæ—¶é—´
      â†“
      â”œâ”€ <= 23:59:49 â†’ åˆ›å»ºå»¶è¿Ÿå®šæ—¶å™¨
      â”‚   â†“
      â”‚   setTimeout(å†·å´ç»“æŸæ—¶é—´)
      â”‚   â†“
      â”‚   æ‰§è¡Œé‡ç½®
      â”‚
      â””â”€ > 23:59:49 â†’ æ”¾å¼ƒï¼ˆè·¨å¤©ï¼‰
```

---

## ğŸ›¡ï¸ å®¹é”™æœºåˆ¶

### 1. ç½‘ç»œå±‚å®¹é”™

```
APIè¯·æ±‚
  â†“
é€Ÿç‡é™åˆ¶å™¨ (ç­‰å¾…ä»¤ç‰Œ)
  â†“
å‘é€è¯·æ±‚
  â”œâ”€ æˆåŠŸ â†’ è¿”å›æ•°æ®
  â””â”€ å¤±è´¥ â†’
      â†“
      é‡è¯•æœºåˆ¶ (æŒ‡æ•°é€€é¿)
      â”œâ”€ ç¬¬1æ¬¡: ç­‰å¾…1ç§’
      â”œâ”€ ç¬¬2æ¬¡: ç­‰å¾…2ç§’
      â”œâ”€ ç¬¬3æ¬¡: ç­‰å¾…4ç§’
      â””â”€ æ”¾å¼ƒ â†’ è®°å½•é”™è¯¯æ—¥å¿—
```

### 2. ä¸šåŠ¡å±‚å®¹é”™

```
è®¢é˜…åˆ—è¡¨å¤„ç†
  â†“
é€ä¸ªè®¢é˜…ä¸²è¡Œå¤„ç†
  â†“
å•ä¸ªè®¢é˜…å¤±è´¥
  â”œâ”€ è®°å½•é”™è¯¯
  â”œâ”€ ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
  â””â”€ ä¸å½±å“å…¶ä»–è®¢é˜…
```

### 3. è°ƒåº¦å±‚å®¹é”™

```
å®šæ—¶ä»»åŠ¡è§¦å‘
  â†“
è·å–ä»»åŠ¡é”
  â”œâ”€ è·å–æˆåŠŸ â†’ æ‰§è¡Œä»»åŠ¡
  â””â”€ è·å–å¤±è´¥ â†’ è·³è¿‡ï¼ˆå·²åœ¨æ‰§è¡Œï¼‰
      â†“
      ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸
      â”œâ”€ è®°å½•é”™è¯¯
      â””â”€ é‡Šæ”¾é”
```

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. PAYGOä¿æŠ¤ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

```javascript
isPAYGO(subscription) {
    return (
        subscriptionPlanName === 'PAYGO' ||
        subscriptionPlan.subscriptionName === 'PAYGO' ||
        subscriptionPlan.planType === 'PAYGO' ||
        subscriptionPlan.planType === 'PAY_PER_USE'
    );
}
```

### 2. API Key è„±æ•

```javascript
sanitizeAPIKey(apiKey) {
    if (!apiKey || apiKey.length < 12) return '***';
    return apiKey.substring(0, 8) + '***';
}
```

### 3. é€Ÿç‡é™åˆ¶

- ä»¤ç‰Œæ¡¶ç®—æ³•
- 10ä¸ªä»¤ç‰Œ/åˆ†é’Ÿ
- é˜²æ­¢APIé™æµ

### 4. æ‰§è¡Œé”

- é˜²æ­¢å¹¶å‘æ‰§è¡Œ
- Mapå­˜å‚¨é”çŠ¶æ€
- è‡ªåŠ¨é‡Šæ”¾

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. ä¸²è¡Œå¤„ç†

```javascript
// é¿å…å¹¶å‘è§¦å‘é™æµ
for (const subscription of eligibleSubscriptions) {
    await processSubscription(subscription);
    await new Promise(resolve => setTimeout(resolve, 1000)); // 1ç§’é—´éš”
}
```

### 2. å•ä¾‹æ¨¡å¼

```javascript
// å…¨å±€å…±äº«é€Ÿç‡é™åˆ¶å™¨
if (!APIClient.rateLimiter && config.enableRateLimit) {
    APIClient.rateLimiter = new RateLimiter(10, 10);
}
```

### 3. å»¶è¿Ÿé‡ç½®

```javascript
// é¿å…å†·å´æœŸå†…çš„æ— æ•ˆè¯·æ±‚
if (cooldown.passed) {
    // ç›´æ¥é‡ç½®
} else {
    // åˆ›å»ºå»¶è¿Ÿå®šæ—¶å™¨ï¼Œåœ¨å†·å´ç»“æŸæ—¶æ‰§è¡Œ
}
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—çº§åˆ«

| çº§åˆ« | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| DEBUG | è°ƒè¯•ä¿¡æ¯ | APIè¯·æ±‚ç»†èŠ‚ |
| INFO | ä¸€èˆ¬ä¿¡æ¯ | é‡ç½®æ‰§è¡Œæ­¥éª¤ |
| WARN | è­¦å‘Šä¿¡æ¯ | å†·å´ä¸­ã€è·³è¿‡ |
| ERROR | é”™è¯¯ä¿¡æ¯ | APIå¤±è´¥ã€å¼‚å¸¸ |
| SUCCESS | æˆåŠŸä¿¡æ¯ | é‡ç½®æˆåŠŸ |

### æ—¥å¿—è¾“å‡º

```
æ§åˆ¶å°è¾“å‡ºï¼ˆå®æ—¶ï¼‰
  â”œâ”€ INFOã€WARNã€ERRORã€SUCCESS
  â””â”€ å½©è‰²æ˜¾ç¤º

æ–‡ä»¶è¾“å‡ºï¼ˆæŒä¹…åŒ–ï¼‰
  â”œâ”€ combined.log (æ‰€æœ‰æ—¥å¿—)
  â”œâ”€ error.log (é”™è¯¯æ—¥å¿—)
  â””â”€ reset-YYYY-MM-DD.log (æŒ‰æ—¥æœŸ)
```

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™ (SRP)
- æ¯ä¸ªç±»/æ¨¡å—åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- Loggerä¸“æ³¨æ—¥å¿—ï¼ŒAPIClientä¸“æ³¨APIé€šä¿¡

### 2. å¼€é—­åŸåˆ™ (OCP)
- å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶è¡Œä¸º

### 3. ä¾èµ–å€’ç½®åŸåˆ™ (DIP)
- ä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
- é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–

### 4. æ¥å£éš”ç¦»åŸåˆ™ (ISP)
- ç²¾ç®€çš„æ¥å£è®¾è®¡
- æ¯ä¸ªæ–¹æ³•èŒè´£æ˜ç¡®

---

## ğŸ“ˆ æ‰©å±•æ€§

### 1. å¤šè´¦å·æ”¯æŒ

```javascript
// æ”¯æŒå¤šä¸ªAPI Key
const apiClients = config.apiKeys.map(apiKey => new APIClient(apiKey));
const resetServices = apiClients.map(client => new ResetService(client));
```

### 2. å­˜å‚¨æ‰©å±•

```javascript
// å¯æ‰©å±•ä¸ºæ•°æ®åº“å­˜å‚¨
class DatabaseStorage extends StorageInterface {
    async saveResetHistory(result) {
        // ä¿å­˜åˆ°æ•°æ®åº“
    }
}
```

### 3. é€šçŸ¥æ‰©å±•

```javascript
// å¯æ·»åŠ é€šçŸ¥åŠŸèƒ½
class NotificationService {
    async notifyResetSuccess(result) {
        // å‘é€é‚®ä»¶/Webhook
    }
}
```

---

## âœ… æ€»ç»“

### æ¶æ„ç‰¹ç‚¹

1. **åˆ†å±‚æ¸…æ™°** - åº”ç”¨å±‚ã€è°ƒåº¦å±‚ã€ä¸šåŠ¡å±‚ã€APIå±‚ã€å·¥å…·å±‚
2. **èŒè´£åˆ†ç¦»** - æ¯å±‚ä¸“æ³¨è‡ªå·±çš„èŒè´£
3. **å®¹é”™å®Œå–„** - ç½‘ç»œã€ä¸šåŠ¡ã€è°ƒåº¦ä¸‰å±‚å®¹é”™
4. **å®‰å…¨å¯é ** - PAYGOä¿æŠ¤ã€é€Ÿç‡é™åˆ¶ã€æ‰§è¡Œé”
5. **æ˜“äºæ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒå¤šç§æ‰©å±•

### æŠ€æœ¯æ ˆ

- **è¿è¡Œæ—¶**: Node.js 16+
- **è°ƒåº¦**: node-cron
- **HTTP**: axios
- **æ—¥å¿—**: winston
- **é…ç½®**: dotenv

### æ ¸å¿ƒä¼˜åŠ¿

- âœ… æ— è„‘é‡ç½®ç­–ç•¥ - ç¡®ä¿æ¯å¤©ç”¨å®Œ2æ¬¡
- âœ… æ™ºèƒ½å»¶è¿Ÿé‡ç½® - æœ€å¤§åŒ–åˆ©ç”¨æœºä¼š
- âœ… å®Œå–„çš„å®¹é”™æœºåˆ¶ - ç¨³å®šå¯é 
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½• - å¯è¿½æº¯
- âœ… æ¨¡å—åŒ–è®¾è®¡ - æ˜“ç»´æŠ¤æ‰©å±•
