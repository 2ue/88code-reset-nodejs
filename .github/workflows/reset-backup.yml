name: 88code é‡ç½®ä»»åŠ¡ - å¤‡ç”¨æ£€æŸ¥ (å·²ç¦ç”¨)

on:
  # å·²ç¦ç”¨ - ä¸ä¼šè‡ªåŠ¨è§¦å‘
  # schedule:
  #   # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼Œä½œä¸ºå¤‡ç”¨
  #   - cron: '0 * * * *'
  #
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reset_type:
        description: 'é‡ç½®ç±»å‹'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto    # è‡ªåŠ¨åˆ¤æ–­
          - first   # é¦–æ¬¡é‡ç½®
          - second  # äºŒæ¬¡é‡ç½®
      force:
        description: 'å¼ºåˆ¶æ‰§è¡Œ'
        required: false
        default: false
        type: boolean

jobs:
  backup-check:
    name: å¤‡ç”¨æ£€æŸ¥å’Œè¡¥æ‰§è¡Œ
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: é…ç½®ç¯å¢ƒå˜é‡
        env:
          API_KEYS: ${{ secrets.API_KEYS }}
          TIMEZONE: Asia/Shanghai
          STATE_DIR: ${{ github.workspace }}/.github
        run: |
          echo "API_KEYS=${API_KEYS}" >> $GITHUB_ENV
          echo "TIMEZONE=${TIMEZONE}" >> $GITHUB_ENV
          echo "STATE_DIR=${STATE_DIR}" >> $GITHUB_ENV

      - name: æ£€æŸ¥æ‰§è¡ŒçŠ¶æ€
        id: check-status
        run: |
          node src/cli.js --stats > execution-stats.txt
          cat execution-stats.txt

          # æå–ä¿¡æ¯
          FIRST_EXECUTED=$(grep "é¦–æ¬¡é‡ç½®: âœ… å·²æ‰§è¡Œ" execution-stats.txt && echo "true" || echo "false")
          SECOND_EXECUTED=$(grep "äºŒæ¬¡é‡ç½®: âœ… å·²æ‰§è¡Œ" execution-stats.txt && echo "true" || echo "false")
          FAILURES=$(grep "æœ€è¿‘24å°æ—¶å¤±è´¥" execution-stats.txt | awk '{print $2}')

          echo "first_executed=$FIRST_EXECUTED" >> $GITHUB_OUTPUT
          echo "second_executed=$SECOND_EXECUTED" >> $GITHUB_OUTPUT
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT

          # è·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(date +%H:%M)
          CURRENT_HOUR=$(date +%H)

          echo "current_time=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "current_hour=$CURRENT_HOUR" >> $GITHUB_OUTPUT

      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦è¡¥æ‰§è¡Œ
        id: decide-action
        run: |
          FIRST_EXECUTED="${{ steps.check-status.outputs.first_executed }}"
          SECOND_EXECUTED="${{ steps.check-status.outputs.second_executed }}"
          FAILURES="${{ steps.check-status.outputs.failures }}"
          CURRENT_HOUR="${{ steps.check-status.outputs.current_hour }}"

          RESET_TYPE=""
          SHOULD_EXECUTE="false"
          REASON=""

          # æ‰‹åŠ¨è§¦å‘
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT_TYPE="${{ github.event.inputs.reset_type }}"

            if [ "$INPUT_TYPE" = "first" ]; then
              RESET_TYPE="FIRST"
              SHOULD_EXECUTE="true"
              REASON="manual_first"
            elif [ "$INPUT_TYPE" = "second" ]; then
              RESET_TYPE="SECOND"
              SHOULD_EXECUTE="true"
              REASON="manual_second"
            elif [ "$INPUT_TYPE" = "auto" ]; then
              # è‡ªåŠ¨åˆ¤æ–­é€»è¾‘
              if [ "$FIRST_EXECUTED" = "false" ] && [ "$CURRENT_HOUR" -ge 19 ] && [ "$CURRENT_HOUR" -le 22 ]; then
                RESET_TYPE="FIRST"
                SHOULD_EXECUTE="true"
                REASON="backup_first_missed"
              elif [ "$SECOND_EXECUTED" = "false" ] && [ "$CURRENT_HOUR" -ge 0 ] && [ "$CURRENT_HOUR" -le 6 ]; then
                RESET_TYPE="SECOND"
                SHOULD_EXECUTE="true"
                REASON="backup_second_missed"
              else
                REASON="no_action_needed"
              fi
            fi
          else
            # å®šæ—¶è§¦å‘çš„è‡ªåŠ¨åˆ¤æ–­
            if [ "$FAILURES" -ge 3 ]; then
              REASON="too_many_failures"
            elif [ "$FIRST_EXECUTED" = "false" ] && [ "$CURRENT_HOUR" -ge 19 ] && [ "$CURRENT_HOUR" -le 22 ]; then
              RESET_TYPE="FIRST"
              SHOULD_EXECUTE="true"
              REASON="backup_first_missed"
            elif [ "$SECOND_EXECUTED" = "false" ] && [ "$CURRENT_HOUR" -ge 0 ] && [ "$CURRENT_HOUR" -le 6 ]; then
              RESET_TYPE="SECOND"
              SHOULD_EXECUTE="true"
              REASON="backup_second_missed"
            else
              REASON="no_action_needed"
            fi
          fi

          echo "reset_type=$RESET_TYPE" >> $GITHUB_OUTPUT
          echo "should_execute=$SHOULD_EXECUTE" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ å†³ç­–ç»“æœ:"
          echo "  - æ‰§è¡Œç±»å‹: $RESET_TYPE"
          echo "  - éœ€è¦æ‰§è¡Œ: $SHOULD_EXECUTE"
          echo "  - åŸå› : $REASON"

      - name: æ‰§è¡Œé‡ç½®
        if: steps.decide-action.outputs.should_execute == 'true'
        env:
          API_KEYS: ${{ secrets.API_KEYS }}
          TIMEZONE: Asia/Shanghai
          STATE_DIR: ${{ github.workspace }}/.github
        run: |
          RESET_TYPE="${{ steps.decide-action.outputs.reset_type }}"
          REASON="${{ steps.decide-action.outputs.reason }}"

          echo "ğŸš€ æ‰§è¡Œå¤‡ç”¨é‡ç½®: $RESET_TYPE"
          echo "ğŸ“ æ‰§è¡ŒåŸå› : $REASON"

          if [ "$RESET_TYPE" = "FIRST" ]; then
            node src/cli.js --first
          elif [ "$RESET_TYPE" = "SECOND" ]; then
            node src/cli.js --second
          fi

      - name: æäº¤çŠ¶æ€æ›´æ–°
        if: steps.decide-action.outputs.should_execute == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -f ".github/reset-state.json" ]; then
            git add .github/reset-state.json
            git commit -m "chore: backup reset executed - ${{ steps.decide-action.outputs.reason }}" || echo "No changes to commit"
            git push || echo "Push failed (non-critical)"
          fi

      - name: å‘é€é€šçŸ¥
        if: always()
        run: |
          SHOULD_EXECUTE="${{ steps.decide-action.outputs.should_execute }}"
          REASON="${{ steps.decide-action.outputs.reason }}"
          JOB_STATUS="${{ job.status }}"

          if [ "$SHOULD_EXECUTE" = "true" ]; then
            if [ "$JOB_STATUS" = "success" ]; then
              echo "âœ… å¤‡ç”¨é‡ç½®æ‰§è¡ŒæˆåŠŸ: $REASON"
            else
              echo "âŒ å¤‡ç”¨é‡ç½®æ‰§è¡Œå¤±è´¥: $REASON"
            fi
          else
            echo "â„¹ï¸ æ— éœ€æ‰§è¡Œ: $REASON"
          fi