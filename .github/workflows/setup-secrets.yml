name: é…ç½®æ£€æŸ¥

on:
  push:
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  check-setup:
    name: æ£€æŸ¥ GitHub Actions é…ç½®
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥ Secrets é…ç½®
        run: |
          echo "ğŸ” æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡é…ç½®"
          echo ""

          # æ£€æŸ¥å¿…éœ€çš„ secrets
          if [ -n "${{ secrets.API_KEYS }}" ]; then
            echo "âœ… API_KEYS: å·²é…ç½®"
            # æ£€æŸ¥æ ¼å¼
            if [[ "${{ secrets.API_KEYS }}" =~ ^88_[a-zA-Z0-9]{40,} ]]; then
              echo "  âœ… æ ¼å¼æ­£ç¡® (88_xxx)"
            else
              echo "  âš ï¸ æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥æ˜¯å¦ä»¥ 88_ å¼€å¤´ä¸”é•¿åº¦è¶³å¤Ÿ"
            fi
          else
            echo "âŒ API_KEYS: æœªé…ç½®"
            echo ""
            echo "ğŸ“ è¯·åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹ Secrets:"
            echo "   Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            echo "   Name: API_KEYS"
            echo "   Value: 88_your_api_key_here"
            echo ""
            echo "   å¤šä¸ª Key å¯ä»¥ç”¨é€—å·åˆ†éš”: 88_key1,88_key2,88_key3"
          fi

          echo ""
          echo "ğŸ“‹ é…ç½®è¯´æ˜:"
          echo "  - API_KEYS: å¿…å¡«ï¼Œ88code API å¯†é’¥"
          echo "  - TIMEZONE: å¯é€‰ï¼Œé»˜è®¤ Asia/Shanghai"
          echo "  - STATE_DIR: å¯é€‰ï¼Œé»˜è®¤ .github ç›®å½•"

      - name: æ£€æŸ¥å·¥ä½œæµé…ç½®
        run: |
          echo "ğŸ” æ£€æŸ¥å·¥ä½œæµé…ç½®"
          echo ""

          # æ£€æŸ¥æ—¶é—´é…ç½®
          echo "ğŸ“… å®šæ—¶ä»»åŠ¡é…ç½®:"
          echo "  - é¦–æ¬¡é‡ç½®è§¦å‘: 10:45 UTC (18:45 Asia/Shanghai)"
          echo "  - äºŒæ¬¡é‡ç½®è§¦å‘: 15:51 UTC (23:51 Asia/Shanghai)"
          echo "  - å¤‡ç”¨æ£€æŸ¥: æ¯å°æ—¶æ•´ç‚¹"
          echo ""

          # æ£€æŸ¥æ—¶åŒº
          echo "ğŸŒ æ—¶åŒºé…ç½®: Asia/Shanghai (UTC+8)"
          echo ""

          echo "â° æ‰§è¡Œæ—¶é—´çº¿:"
          echo "  18:45 Asia/Shanghai - è§¦å‘é¦–æ¬¡é‡ç½®ä»»åŠ¡"
          echo "  18:45-18:55 Asia/Shanghai - ç­‰å¾…åˆ°ç›®æ ‡æ—¶é—´"
          echo "  18:55 Asia/Shanghai - æ‰§è¡Œé¦–æ¬¡é‡ç½®"
          echo "  23:51 Asia/Shanghai - è§¦å‘äºŒæ¬¡é‡ç½®ä»»åŠ¡"
          echo "  23:51-23:56 Asia/Shanghai - ç­‰å¾…åˆ°ç›®æ ‡æ—¶é—´"
          echo "  23:56 Asia/Shanghai - æ‰§è¡ŒäºŒæ¬¡é‡ç½®"
          echo "  æ¯å°æ—¶æ•´ç‚¹ - å¤‡ç”¨æ£€æŸ¥"
          echo ""

      - name: ç”Ÿæˆé…ç½®æŒ‡å—
        run: |
          echo "ğŸ“– GitHub Actions é…ç½®å®ŒæˆæŒ‡å—"
          echo "======================================"
          echo ""

          if [ -n "${{ secrets.API_KEYS }}" ]; then
            echo "âœ… æ‰€æœ‰å¿…éœ€é…ç½®å·²å®Œæˆï¼"
            echo ""
            echo "ğŸš€ æ¥ä¸‹æ¥å¯ä»¥:"
            echo "  1. ç­‰å¾…å®šæ—¶ä»»åŠ¡è§¦å‘"
            echo "  2. æˆ–æ‰‹åŠ¨è§¦å‘æµ‹è¯•:"
            echo "     - åœ¨ Actions é¡µé¢æ‰¾åˆ° '88code é‡ç½®ä»»åŠ¡'"
            echo "     - ç‚¹å‡» 'Run workflow'"
            echo "     - é€‰æ‹©é‡ç½®ç±»å‹è¿›è¡Œæµ‹è¯•"
            echo ""
            echo "ğŸ“Š ç›‘æ§æ–¹å¼:"
            echo "  1. æŸ¥çœ‹ Actions é¡µé¢çš„æ‰§è¡Œæ—¥å¿—"
            echo "  2. æ£€æŸ¥ .github/reset-state.json æ–‡ä»¶"
            echo "  3. ä½¿ç”¨ node src/cli.js --stats æŸ¥çœ‹ç»Ÿè®¡"
          else
            echo "âš ï¸ è¿˜éœ€è¦é…ç½® API_KEYS Secret"
            echo ""
            echo "ğŸ“ é…ç½®æ­¥éª¤:"
            echo "  1. è¿›å…¥ä»“åº“ Settings é¡µé¢"
            echo "  2. å·¦ä¾§èœå•é€‰æ‹© 'Secrets and variables'"
            echo "  3. é€‰æ‹© 'Actions'"
            echo "  4. ç‚¹å‡» 'New repository secret'"
            echo "  5. Name: API_KEYS"
            echo "  6. Value: ä½ çš„ 88code API å¯†é’¥"
            echo ""
            echo "ğŸ’¡ å¤šè´¦å·é…ç½®ç¤ºä¾‹:"
            echo "  88_first_api_key_here,88_second_api_key_here,88_third_api_key_here"
          fi

      - name: æµ‹è¯• CLI å·¥å…·
        if: secrets.API_KEYS != ''
        env:
          API_KEYS: ${{ secrets.API_KEYS }}
          TIMEZONE: Asia/Shanghai
          STATE_DIR: ${{ github.workspace }}/.github
        run: |
          echo "ğŸ§ª æµ‹è¯• CLI å·¥å…·"
          echo ""

          # å®‰è£…ä¾èµ–
          npm ci

          # æµ‹è¯•ç»Ÿè®¡åŠŸèƒ½
          echo "ğŸ“Š æµ‹è¯•ç»Ÿè®¡åŠŸèƒ½:"
          node src/cli.js --stats
          echo ""

          # æµ‹è¯•ç©ºè¿è¡Œ
          echo "ğŸ” æµ‹è¯•ç©ºè¿è¡Œæ¨¡å¼:"
          node src/cli.js --first --dry-run
          echo ""

          echo "âœ… CLI å·¥å…·æµ‹è¯•å®Œæˆ"

      - name: é€šçŸ¥
        run: |
          if [ -n "${{ secrets.API_KEYS }}" ]; then
            echo "ğŸ‰ GitHub Actions é…ç½®æ£€æŸ¥å®Œæˆï¼"
            echo ""
            echo "ğŸ“‹ åŠŸèƒ½ç‰¹æ€§:"
            echo "  âœ… æå‰10åˆ†é’Ÿè§¦å‘ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿå‡†å¤‡æ—¶é—´"
            echo "  âœ… æ™ºèƒ½ç­‰å¾…åˆ°ç›®æ ‡æ—¶é—´æ‰§è¡Œ"
            echo "  âœ… å¹‚ç­‰æ€§æ£€æŸ¥ï¼Œé¿å…é‡å¤æ‰§è¡Œ"
            echo "  âœ… å¤‡ç”¨æ£€æŸ¥æœºåˆ¶ï¼Œé˜²æ­¢é—æ¼"
            echo "  âœ… çŠ¶æ€æŒä¹…åŒ–ï¼Œæ”¯æŒæ¢å¤"
            echo "  âœ… å®Œæ•´çš„æ—¥å¿—å’Œç›‘æ§"
          else
            echo "âš ï¸ è¯·å…ˆé…ç½® API_KEYS Secret åå†æ¬¡è¿è¡Œæ­¤æ£€æŸ¥"
          fi