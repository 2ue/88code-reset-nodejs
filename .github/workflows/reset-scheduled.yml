name: 88code é‡ç½®ä»»åŠ¡

permissions:
  contents: write

on:
  schedule:
    # æå‰10åˆ†é’Ÿè§¦å‘é¦–æ¬¡é‡ç½® (18:45 Asia/Shanghai = 10:45 UTC)
    - cron: '45 10 * * *'
    # æå‰5åˆ†é’Ÿè§¦å‘äºŒæ¬¡é‡ç½® (23:51 Asia/Shanghai = 15:51 UTC)
    - cron: '51 15 * * *'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      reset_type:
        description: 'é‡ç½®ç±»å‹'
        required: true
        default: 'first'
        type: choice
        options:
          - first
          - second
      force:
        description: 'å¼ºåˆ¶æ‰§è¡Œ'
        required: false
        default: false
        type: boolean

jobs:
  first-reset:
    name: é¦–æ¬¡é‡ç½® (18:55)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: (github.event.schedule == '45 10 * * *') || (github.event.inputs.reset_type == 'first')

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: é…ç½®ç¯å¢ƒå˜é‡
        env:
          API_KEYS: ${{ secrets.API_KEYS }}
          TIMEZONE: Asia/Shanghai
          STATE_DIR: ${{ github.workspace }}/.github
        run: |
          echo "API_KEYS=${API_KEYS}" >> $GITHUB_ENV
          echo "TIMEZONE=${TIMEZONE}" >> $GITHUB_ENV
          echo "STATE_DIR=${STATE_DIR}" >> $GITHUB_ENV

      - name: æ£€æŸ¥æ‰§è¡ŒçŠ¶æ€
        id: check-status
        run: |
          node src/cli.js --stats > execution-stats.txt
          cat execution-stats.txt

          # æ£€æŸ¥æ˜¯å¦å·²æ‰§è¡Œè¿‡
          if grep -q "é¦–æ¬¡é‡ç½®: âœ… å·²æ‰§è¡Œ" execution-stats.txt; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=already_executed_today" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: ç­‰å¾…åˆ°ç›®æ ‡æ—¶é—´
        if: steps.check-status.outputs.skip == 'false'
        env:
          TARGET_TIME: "18:55:00"
          TIMEOUT_MINUTES: 15
        run: |
          echo "â° ç­‰å¾…åˆ°ç›®æ ‡æ—¶é—´: $TARGET_TIME"
          echo "â° å½“å‰æ—¶åŒº: $TIMEZONE"

          # è®¡ç®—ç›®æ ‡æ—¶é—´æˆ³
          TARGET_TIMESTAMP=$(date -d "$TARGET_TIME" +%s)
          CURRENT_TIMESTAMP=$(date +%s)

          echo "ğŸ“… ç›®æ ‡æ—¶é—´æˆ³: $TARGET_TIMESTAMP"
          echo "ğŸ“… å½“å‰æ—¶é—´æˆ³: $CURRENT_TIMESTAMP"

          # å¦‚æœå·²ç»è¶…è¿‡ç›®æ ‡æ—¶é—´ï¼Œç›´æ¥æ‰§è¡Œ
          if [ $CURRENT_TIMESTAMP -gt $TARGET_TIMESTAMP ]; then
            echo "âš¡ å·²è¿‡ç›®æ ‡æ—¶é—´ï¼Œç›´æ¥æ‰§è¡Œ"
          else
            # è®¡ç®—ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
            WAIT_SECONDS=$((TARGET_TIMESTAMP - CURRENT_TIMESTAMP))
            TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))

            echo "â±ï¸ éœ€è¦ç­‰å¾…: ${WAIT_SECONDS}ç§’"
            echo "â±ï¸ è¶…æ—¶æ—¶é—´: ${TIMEOUT_SECONDS}ç§’"

            # å¦‚æœç­‰å¾…æ—¶é—´è¶…è¿‡è¶…æ—¶æ—¶é—´ï¼Œï¿½ï¿½ï¿½è¿‡
            if [ $WAIT_SECONDS -gt $TIMEOUT_SECONDS ]; then
              echo "âš ï¸ ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œè·³è¿‡æ‰§è¡Œ"
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "reason=wait_timeout" >> $GITHUB_OUTPUT
              exit 0
            fi

            # ç­‰å¾…åˆ°ç›®æ ‡æ—¶é—´
            echo "â³ å¼€å§‹ç­‰å¾…..."

            while [ $(date +%s) -lt $TARGET_TIMESTAMP ]; do
              CURRENT=$(date +%s)
              REMAINING=$((TARGET_TIMESTAMP - CURRENT))

              if [ $REMAINING -le 0 ]; then
                break
              fi

              if [ $REMAINING -le 60 ]; then
                echo "ğŸ• å³å°†æ‰§è¡Œï¼Œå‰©ä½™ ${REMAINING}ç§’"
                sleep 5
              elif [ $REMAINING -le 300 ]; then
                echo "â³ ç­‰å¾…ä¸­ï¼Œå‰©ä½™ ${REMAINING}ç§’"
                sleep 30
              else
                echo "ğŸ’¤ ç­‰å¾…ä¸­ï¼Œå‰©ä½™ ${REMAINING}ç§’"
                sleep 60
              fi
            done

            echo "âœ… ç­‰å¾…å®Œæˆï¼Œå¼€å§‹æ‰§è¡Œ"
          fi

      - name: æ‰§è¡Œé¦–æ¬¡é‡ç½®
        if: steps.check-status.outputs.skip == 'false'
        env:
          API_KEYS: ${{ secrets.API_KEYS }}
          TIMEZONE: Asia/Shanghai
          STATE_DIR: ${{ github.workspace }}/.github
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œé¦–æ¬¡é‡ç½®"
          node src/cli.js --first

      - name: æäº¤çŠ¶æ€æ›´æ–°
        if: always() && steps.check-status.outputs.skip == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ çŠ¶æ€æ–‡ä»¶
          if [ -f ".github/reset-state.json" ]; then
            git add .github/reset-state.json
            git commit -m "chore: update first reset execution state" || echo "No changes to commit"
            git push || echo "Push failed (non-critical)"
          fi

      - name: åˆ›å»ºæˆåŠŸé€šçŸ¥
        if: success() && steps.check-status.outputs.skip == 'false'
        run: |
          echo "âœ… é¦–æ¬¡é‡ç½®æ‰§è¡ŒæˆåŠŸ"

      - name: å¤±è´¥é€šçŸ¥
        if: failure() && steps.check-status.outputs.skip == 'false'
        run: |
          echo "âŒ é¦–æ¬¡é‡ç½®æ‰§è¡Œå¤±è´¥"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨å¤„ç†"

  second-reset:
    name: äºŒæ¬¡é‡ç½® (23:56)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: (github.event.schedule == '51 15 * * *') || (github.event.inputs.reset_type == 'second')

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: é…ç½®ç¯å¢ƒå˜é‡
        env:
          API_KEYS: ${{ secrets.API_KEYS }}
          TIMEZONE: Asia/Shanghai
          STATE_DIR: ${{ github.workspace }}/.github
        run: |
          echo "API_KEYS=${API_KEYS}" >> $GITHUB_ENV
          echo "TIMEZONE=${TIMEZONE}" >> $GITHUB_ENV
          echo "STATE_DIR=${STATE_DIR}" >> $GITHUB_ENV

      - name: æ£€æŸ¥æ‰§è¡ŒçŠ¶æ€
        id: check-status
        run: |
          node src/cli.js --stats > execution-stats.txt
          cat execution-stats.txt

          # æ£€æŸ¥æ˜¯å¦å·²æ‰§è¡Œè¿‡
          if grep -q "äºŒæ¬¡é‡ç½®: âœ… å·²æ‰§è¡Œ" execution-stats.txt; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=already_executed_today" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: ç­‰å¾…åˆ°ç›®æ ‡æ—¶é—´
        if: steps.check-status.outputs.skip == 'false'
        env:
          TARGET_TIME: "23:56:00"
          TIMEOUT_MINUTES: 10
        run: |
          echo "â° ç­‰å¾…åˆ°ç›®æ ‡æ—¶é—´: $TARGET_TIME"
          echo "â° å½“å‰æ—¶åŒº: $TIMEZONE"

          # è®¡ç®—ç›®æ ‡æ—¶é—´æˆ³
          TARGET_TIMESTAMP=$(date -d "$TARGET_TIME" +%s)
          CURRENT_TIMESTAMP=$(date +%s)

          echo "ğŸ“… ç›®æ ‡æ—¶é—´æˆ³: $TARGET_TIMESTAMP"
          echo "ğŸ“… å½“å‰æ—¶é—´æˆ³: $CURRENT_TIMESTAMP"

          # å¦‚æœå·²ç»è¶…è¿‡ç›®æ ‡æ—¶é—´ï¼Œæ£€æŸ¥æ˜¯å¦è¿˜èƒ½æ‰§è¡Œ
          if [ $CURRENT_TIMESTAMP -gt $TARGET_TIMESTAMP ]; then
            # è®¡ç®—è¶…æ—¶æ—¶é—´
            LATE_SECONDS=$((CURRENT_TIMESTAMP - TARGET_TIMESTAMP))
            MAX_LATE_SECONDS=600  # æœ€å¤šå»¶è¿Ÿ10åˆ†é’Ÿ

            if [ $LATE_SECONDS -gt $MAX_LATE_SECONDS ]; then
              echo "âš ï¸ è¶…è¿‡æ—¶é—´é™åˆ¶ï¼Œè·³è¿‡æ‰§è¡Œ"
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "reason=too_late" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âš¡ ç¨å¾®è¶…æ—¶ï¼Œä½†ä»åœ¨å¯æ¥å—èŒƒå›´å†…"
            fi
          else
            # è®¡ç®—ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
            WAIT_SECONDS=$((TARGET_TIMESTAMP - CURRENT_TIMESTAMP))
            TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))

            echo "â±ï¸ éœ€è¦ç­‰å¾…: ${WAIT_SECONDS}ç§’"
            echo "â±ï¸ è¶…æ—¶æ—¶é—´: ${TIMEOUT_SECONDS}ç§’"

            # å¦‚æœç­‰å¾…æ—¶é—´è¶…è¿‡è¶…æ—¶æ—¶é—´ï¼Œè·³è¿‡
            if [ $WAIT_SECONDS -gt $TIMEOUT_SECONDS ]; then
              echo "âš ï¸ ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œè·³è¿‡æ‰§è¡Œ"
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "reason=wait_timeout" >> $GITHUB_OUTPUT
              exit 0
            fi

            # ç­‰å¾…åˆ°ç›®æ ‡æ—¶é—´
            echo "â³ å¼€å§‹ç­‰å¾…..."

            while [ $(date +%s) -lt $TARGET_TIMESTAMP ]; do
              CURRENT=$(date +%s)
              REMAINING=$((TARGET_TIMESTAMP - CURRENT))

              if [ $REMAINING -le 0 ]; then
                break
              fi

              if [ $REMAINING -le 60 ]; then
                echo "ğŸ• å³å°†æ‰§è¡Œï¼Œå‰©ä½™ ${REMAINING}ç§’"
                sleep 5
              elif [ $REMAINING -le 300 ]; then
                echo "â³ ç­‰å¾…ä¸­ï¼Œå‰©ä½™ ${REMAINING}ç§’"
                sleep 30
              else
                echo "ğŸ’¤ ç­‰å¾…ä¸­ï¼Œå‰©ä½™ ${REMAINING}ç§’"
                sleep 60
              fi
            done

            echo "âœ… ç­‰å¾…å®Œæˆï¼Œå¼€å§‹æ‰§è¡Œ"
          fi

      - name: æ‰§è¡ŒäºŒæ¬¡é‡ç½®
        if: steps.check-status.outputs.skip == 'false'
        env:
          API_KEYS: ${{ secrets.API_KEYS }}
          TIMEZONE: Asia/Shanghai
          STATE_DIR: ${{ github.workspace }}/.github
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡ŒäºŒæ¬¡é‡ç½®"
          node src/cli.js --second

      - name: æäº¤çŠ¶æ€æ›´æ–°
        if: always() && steps.check-status.outputs.skip == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ çŠ¶æ€æ–‡ä»¶
          if [ -f ".github/reset-state.json" ]; then
            git add .github/reset-state.json
            git commit -m "chore: update second reset execution state" || echo "No changes to commit"
            git push || echo "Push failed (non-critical)"
          fi

      - name: åˆ›å»ºæˆåŠŸé€šçŸ¥
        if: success() && steps.check-status.outputs.skip == 'false'
        run: |
          echo "âœ… äºŒæ¬¡é‡ç½®æ‰§è¡ŒæˆåŠŸ"

      - name: å¤±è´¥é€šçŸ¥
        if: failure() && steps.check-status.outputs.skip == 'false'
        run: |
          echo "âŒ äºŒæ¬¡é‡ç½®æ‰§è¡Œå¤±è´¥"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨å¤„ç†"