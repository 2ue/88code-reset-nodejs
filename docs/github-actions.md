# GitHub Actions 部署指南

## 🎯 概述

本指南介绍如何使用 GitHub Actions 实现自动重置任务，实现**提前启动 + 智能等待**的科学方案。

## ⚡ 工作原理

### 时间策略

| 本地时间 | GitHub Actions 触发时间 | 等待时间 | 执行时间 |
|---------|-------------------------|----------|----------|
| **18:55** | 18:45 (提前10分钟) | 10分钟 | 18:55 |
| **23:56** | 23:51 (提前5分钟)  | 5分钟  | 23:56 |

### 备用机制

- **每小时检查**：防止主任务遗漏
- **幂等性保护**：避免重复执行
- **失败重试**：自动检测并补执行

## 🛠️ 配置步骤

### 1. 配置 Secrets

进入仓库设置页面：
```
Settings → Secrets and variables → Actions → New repository secret
```

**必需配置**：
- Name: `API_KEYS`
- Value: `88_your_api_key_here` (多个用逗号分隔)

### 2. 验证配置

运行配置检查：
```
1. 进入 Actions 页面
2. 选择 "配置检查" workflow
3. 点击 "Run workflow"
4. 查看结果确保配置正确
```

### 3. 手动测试

测试首次重置：
```
1. 进入 Actions 页面
2. 选择 "88code 重置任务" workflow
3. 点击 "Run workflow"
4. 重置类型: first
5. 点击 "Run workflow"
```

测试二次重置：
```
1. 同上
2. 重置类型: second
```

## 📋 工作流说明

### 主要工作流

#### 1. `reset-scheduled.yml` - 主定时任务

```yaml
# 触发时间（UTC）
- cron: '45 10 * * *'  # 18:45 Asia/Shanghai (首次重置)
- cron: '51 15 * * *'  # 23:51 Asia/Shanghai (二次重置)
```

**执行流程**：
1. **提前触发**：比目标时间提前5-10分钟
2. **状态检查**：确认今天是否已执行
3. **智能等待**：等待到准确目标时间
4. **执行重置**：调用 CLI 工具执行
5. **状态保存**：更新执行记录

#### 2. `reset-backup.yml` - 备用检查

```yaml
# 触发时间
- cron: '0 * * * *'  # 每小时检查
```

**智能补执行逻辑**：
- 19:00-22:00：检查首次重置是否遗漏
- 00:00-06:00：检查二次重置是否遗漏
- 手动触发：支持任意时间强制执行

#### 3. `setup-secrets.yml` - 配置检查

```yaml
# 触发条件
- push to .github/workflows/**
- manual trigger
```

**检查项目**：
- API Keys 配置
- 时间配置
- CLI 工具功能

## 🔍 监控和调试

### 1. 查看执行状态

使用 CLI 工具查看统计：
```bash
npm run reset:stats
```

输出示例：
```
========== 执行统计 ==========
今日执行状态:
  - 首次重置: ✅ 已执行
  - 二次重置: ⏸️ 未执行
最后执行日期: 2025-11-06
历史执行次数: 15
最近24小时失败: 0
历史失败次数: 2
============================
```

### 2. 查看详细日志

在 GitHub Actions 页面：
```
Actions → 88code 重置任务 → 点击执行记录 → 查看日志
```

关键日志部分：
- **状态检查**：显示今天是否已执行
- **等待逻辑**：显示等待倒计时
- **执行结果**：显示重置成功/失败详情

### 3. 本地调试

在本地测试 CLI 功能：
```bash
# 空运行测试
npm run reset:test

# 查看统计
npm run reset:stats

# 强制执行（跳过幂等性检查）
node src/cli.js --first --force
```

## ⚠️ 重要注意事项

### 1. 时间精度理解

**GitHub Actions 的限制**：
- ⏰ 定时触发可能有 3-15 分钟延迟
- 🚫 高负载时可能跳过执行
- 📊 无法保证精确到秒级

**我们的应对策略**：
- ✅ 提前 5-10 分钟触发
- ✅ 智能等待到目标时间
- ✅ 幂等性检查避免重复
- ✅ 备用检查机制

### 2. 失败处理

**自动重试机制**：
- 每小时备用检查
- 连续失败 3 次后暂停自动执行
- 支持手动强制重试

**手动恢复**：
```bash
# 查看失败原因
npm run reset:stats

# 强制执行
node src/cli.js --first --force
```

### 3. 状态持久化

状态文件位置：`.github/reset-state.json`

包含信息：
- 每日执行记录
- 失败历史
- 最后执行时间

## 📊 性能优化

### 1. 资源使用

**GitHub Actions 限制**：
- 免费账户：2000 分钟/月
- 每次执行：约 2-5 分钟

**优化策略**：
- ✅ 智能等待减少无效执行
- ✅ 幂等性检查避免重复
- ✅ 备用检查只在必要时执行

### 2. 并发控制

**防止重复执行**：
- 🔒 执行锁机制
- 📝 状态文件记录
- ⏰ 时间窗口检查

## 🚀 最佳实践

### 1. 部署建议

**生产环境**：
- ✅ 主要依赖云平台定时任务（Railway/Render/Fly.io）
- ✅ GitHub Actions 作为备用和监控
- ✅ 本地 PM2 作为开发和测试

**开发环境**：
- ✅ 使用 CLI 工具手动测试
- ✅ 利用空运行模式验证逻辑
- ✅ 监控日志确保正常运行

### 2. 监控策略

**日常监控**：
- 📊 每日查看执行统计
- 🔍 定期检查 Actions 日志
- ⚠️ 关注失败通知

**故障处理**：
- 🛠️ API 变更：更新 API_BASE_URL
- 🔑 密钥更新：更新 API_KEYS Secret
- ⏰ 时间调整：修改工作流 cron 表达式

## 📞 故障排除

### 常见问题

**Q: Actions 没有触发？**
A: 检查仓库设置中 Actions 是否启用，确认 cron 表达式正确

**Q: 执行失败？**
A: 查看日志中的错误信息，通常是 API Keys 配置问题

**Q: 重复执行？**
A: 幂等性检查会阻止，检查状态文件是否正常更新

**Q: 时间不准确？**
A: 确认 TIMEZONE 环境变量设置正确

### 紧急恢复

如果 GitHub Actions 完全失效：

1. **本地手动执行**：
   ```bash
   node src/cli.js --first --force
   node src/cli.js --second --force
   ```

2. **部署到云平台**：
   ```bash
   # Railway
   railway deploy

   # Render
   git push origin main
   ```

3. **重新配置 Actions**：
   - 检查 Secrets 配置
   - 验证工作流语法
   - 重新触发手动测试

---

## 📝 更新日志

- **v1.0** - 基础 GitHub Actions 集成
- **v1.1** - 添加智能等待逻辑
- **v1.2** - 实现幂等性检查
- **v1.3** - 增加备用检查机制
- **v1.4** - 完善监控和通知